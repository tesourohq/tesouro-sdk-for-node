name: Examples Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'examples/**'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/examples-test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'examples/**'
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'

env:
  NODE_ENV: test

jobs:
  test-examples:
    name: Test Example Projects
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install main package dependencies
        run: npm ci

      - name: Build main SDK package
        run: |
          npm run codegen
          npm run build

      - name: Create SDK package for examples
        run: |
          npm pack
          SDK_PACKAGE=$(ls tesouro-tesouro-sdk-for-node-*.tgz)
          echo "SDK_PACKAGE=$SDK_PACKAGE" >> $GITHUB_ENV

      - name: Test basic examples TypeScript compilation
        run: |
          echo "üîç Testing basic example TypeScript compilation..."
          
          # Test basic examples
          for example_file in examples/basic/*.ts examples/advanced/*.ts examples/patterns/*.ts; do
            if [ -f "$example_file" ]; then
              echo "Checking TypeScript compilation for: $example_file"
              npx tsc --noEmit --skipLibCheck --esModuleInterop --moduleResolution node "$example_file"
            fi
          done

      - name: Test example project setup and compilation
        run: |
          echo "üß™ Testing example test project..."
          cd examples/test-project
          
          # Install dependencies
          npm ci
          
          # Install the locally built SDK package
          npm install "../../$SDK_PACKAGE"
          
          # Verify the package is correctly installed
          node -e "
            const sdk = require('@tesouro/tesouro-sdk-for-node');
            if (!sdk.TesouroClient) throw new Error('TesouroClient not found in installed package');
            console.log('‚úÖ SDK package correctly installed in example project');
          "

      - name: Test example project TypeScript compilation
        run: |
          cd examples/test-project
          
          echo "üî® Testing TypeScript compilation..."
          npx tsc --noEmit
          
          echo "‚úÖ Example project TypeScript compilation successful"

      - name: Validate example environment setup
        run: |
          cd examples/test-project
          
          echo "üìã Validating example environment..."
          
          # Check if required files exist
          if [ ! -f "src/setup.ts" ]; then
            echo "‚ùå Missing setup.ts example"
            exit 1
          fi
          
          if [ ! -f "src/auth.ts" ]; then
            echo "‚ùå Missing auth.ts example"
            exit 1
          fi
          
          if [ ! -f "src/query.ts" ]; then
            echo "‚ùå Missing query.ts example"
            exit 1
          fi
          
          if [ ! -f "src/mutations.ts" ]; then
            echo "‚ùå Missing mutations.ts example"
            exit 1
          fi
          
          echo "‚úÖ All required example files present"

      - name: Test example imports and basic syntax
        run: |
          cd examples/test-project
          
          echo "üîó Testing example imports..."
          
          # Test that each example file can be imported without errors
          for example_file in src/*.ts; do
            if [ -f "$example_file" ]; then
              echo "Testing imports in: $example_file"
              # Create a test file that imports the example
              cat > test_import.ts << EOF
          import './${example_file#src/}';
          console.log('‚úÖ Import successful for ${example_file}');
          EOF
              npx ts-node --transpile-only test_import.ts
              rm test_import.ts
            fi
          done

      - name: Validate documentation examples
        run: |
          echo "üìö Validating documentation examples..."
          
          # Check that README examples use correct imports
          if grep -q "import.*@tesouro/tesouro-sdk-for-node" README.md; then
            echo "‚úÖ README contains correct import statements"
          else
            echo "‚ö†Ô∏è README might be missing import examples"
          fi
          
          # Check that examples in docs/ directory exist and compile
          if [ -d "docs/" ]; then
            find docs/ -name "*.md" -exec grep -l "```typescript" {} \; | while read doc_file; do
              echo "Found TypeScript examples in: $doc_file"
              # Could extract and validate TypeScript blocks here
            done
          fi

      - name: Test example patterns compilation
        run: |
          echo "üéØ Testing pattern examples..."
          
          cd examples/patterns
          
          # Test each pattern file individually
          for pattern_file in *.ts; do
            if [ -f "$pattern_file" ]; then
              echo "Testing pattern: $pattern_file"
              # Compile with stricter settings to catch issues
              npx tsc --noEmit --strict --esModuleInterop --moduleResolution node "$pattern_file"
            fi
          done

      - name: Generate examples test report
        run: |
          echo "üìä **Examples Test Summary**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Basic Examples**: TypeScript compilation successful" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Test Project**: Package installation and compilation successful" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Pattern Examples**: All patterns compile successfully" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Documentation**: Examples validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Example Files Tested:**" >> $GITHUB_STEP_SUMMARY
          find examples/ -name "*.ts" | while read file; do
            echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
          done

  test-example-documentation:
    name: Documentation Examples Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build SDK
        run: |
          npm run codegen
          npm run build

      - name: Validate README examples
        run: |
          echo "üìñ Validating README code examples..."
          
          # Extract TypeScript code blocks from README
          mkdir -p temp-examples
          
          # This is a basic extraction - in practice you might want a more sophisticated parser
          grep -A 20 "```typescript" README.md | grep -v "```" | grep -v "^--$" > temp-examples/readme-example.ts || true
          
          if [ -s temp-examples/readme-example.ts ]; then
            echo "Found TypeScript examples in README, testing compilation..."
            
            # Add necessary imports at the top
            cat > temp-examples/full-example.ts << 'EOF'
          import { TesouroClient } from '@tesouro/tesouro-sdk-for-node';
          import { randomUUID } from 'crypto';
          
          // Extracted examples would go here
          EOF
            cat temp-examples/readme-example.ts >> temp-examples/full-example.ts
            
            # Test compilation (allowing errors since it's just syntax checking)
            npx tsc --noEmit --skipLibCheck temp-examples/full-example.ts || echo "‚ö†Ô∏è README examples have compilation issues"
          else
            echo "‚ÑπÔ∏è No TypeScript examples found in README"
          fi

      - name: Check Quick Start guide
        run: |
          if [ -f "docs/QUICKSTART.md" ]; then
            echo "üìö Validating Quick Start guide..."
            
            # Check that the quick start guide references correct package name
            if grep -q "@tesouro/tesouro-sdk-for-node" docs/QUICKSTART.md; then
              echo "‚úÖ Quick Start guide uses correct package name"
            else
              echo "‚ö†Ô∏è Quick Start guide might have incorrect package references"
            fi
          else
            echo "‚ÑπÔ∏è No Quick Start guide found"
          fi

      - name: Validate example project README
        run: |
          if [ -f "examples/test-project/README.md" ]; then
            echo "üìã Validating example project README..."
            cd examples/test-project
            
            # Check that the README has setup instructions
            if grep -q "npm install" README.md; then
              echo "‚úÖ Example project README contains installation instructions"
            else
              echo "‚ö†Ô∏è Example project README might be missing setup instructions"
            fi
          fi